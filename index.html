
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>ë‚‘ê°± ê°€ê³„ë¶€</title>
  <style>
    :root{
    /* Cloud Dancer base (soft white) */
    --bg: #f7f7f8;
    --panel: #ffffff;
    --panel2: #f1f1f4;
    --text: #111111;
    --muted: #666666;
    --line: rgba(0,0,0,.08);
    --expense-red: #C85C5C;   /* ğŸŒ¹ ì§€ì¶œ (Muted Rose Red) */
    --income-green: #20c997;  /* ì´ë¯¸ ì“°ê³  ìˆëŠ” ok ì»¬ëŸ¬ */

    /* accents */
    --accent:#4da3ff;
    --danger:#ff5b5b;
    --ok:#20c997;

    --radius:16px;

    /* NEW: surfaces used by header/tabbar/modal */
    --surface: rgba(255,255,255,.78);
    --surface-strong: rgba(255,255,255,.92);
    --shadow: rgba(0,0,0,.12);
    --overlay: rgba(0,0,0,.35);
    }

    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      padding-bottom: calc(72px + env(safe-area-inset-bottom));
    }

    /* ìƒë‹¨ í—¤ë” */
  .header{
    position:sticky; top:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.72));
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
    padding: 18px 16px 12px;
    z-index: 10;
  }
    .title{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap :12px;
    }
    .title h1{
      margin:0;
      font-size:24px;
      letter-spacing:-.3px;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    /* ë©”ì¸ ì˜ì—­ */
    .container{
      padding:16px;
      max-width:720px;
      margin:0 auto;
    }

    /* ì¹´ë“œ */
    .card{
      background: var(--panel); 
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 10px 26px var(--shadow);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:-.2px;
    }
    .hint{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      margin:0;
    }

    /* íƒ­ í˜ì´ì§€ */
    .page{ display:none; }
    .page.active{ display:block; }

    /* í•˜ë‹¨ íƒ­ë°” */
    .tabbar{
     position:fixed; left:0; right:0; bottom:0;
     height:66px;
     background: rgba(255,255,255,.82);
     backdrop-filter: blur(14px);
     border-top:1px solid var(--line);
     display:flex;
     padding:8px 10px 10px;
     z-index:10;
    }
    
    .tab{
      flex:1;
      border:none;
      background:transparent;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      border-radius:14px;
      font-size:11px;
      cursor:pointer;
    }
    .tab .icon{font-size:18px; line-height:1}
    .tab.active{
      color:var(--text);
    }
    .tab.active .icon{
      filter: drop-shadow(0 0 10px rgba(77,163,255,.25));
    }

    
    /* âœ… FAB (ìµœì¢… ì •ë¦¬ë³¸) */
  .fab{
    position: fixed;
    right: 18px;
    bottom: 86px;
    width: 54px;
    height: 54px;
    border-radius: 18px;

    display: flex;
    align-items: center;
    justify-content: center;

    font-size: 30px;
    line-height: 1;
    padding-bottom: 2px;

    cursor: pointer;
    z-index: 12;

    /* Sage í†¤ */
    background: linear-gradient(180deg, #8FBFB0, #7FAE9E);
    color: #F7F8FA;
    text-shadow: 0 1px 0 rgba(46,50,58,.12);

    /* í…Œë‘ë¦¬ & ê·¸ë¦¼ì */
    border: none;
    box-shadow:
      0 12px 26px rgba(127,174,158,.35),
      inset 0 1px 0 rgba(255,255,255,.75);
    }
    
    
    /* ì‘ì€ ë°°ì§€ */
    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--muted);
      font-size:12px;
    }

    .modal{
      position:fixed; inset:0;
      background: var(--overlay);
      display:flex; align-items:flex-end;
      z-index:20;
    }
    .modal.hidden{display:none}
    .sheet{
      width:100%;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:20px 20px 0 0;
      padding:16px;
    }
    .sheet h3{margin:0 0 12px}
    .row{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    input,select{
      background:var(--panel2);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px;
      border-radius:10px;
    }
    .actions{
      display: flex;
      gap: 12px;        /* ì§€ì¶œ/ìˆ˜ì… gapì´ 10ì´ë©´ 10~12 */
      margin-top: 12px;
    }
    .actions button{
      flex: 1;
      height: 44px;           /* âœ… ì§€ì¶œ/ìˆ˜ì…ê³¼ ë™ì¼ */
      border-radius: 14px;    /* âœ… ì§€ì¶œ/ìˆ˜ì…ê³¼ ë™ì¼ */
      border: none;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: -0.2px;
      cursor: pointer;
      padding: 12px;
      margin-top: 22px;
    }

    /* ì—­í• ë³„ ì°¨ì´ë§Œ */
    #save{ opacity: .9; }
    #close{ opacity: .75; }
   
    .actions .ghost{
      background: transparent; 
      color: var(--muted);
    } 

    /* ì €ì¥/ë‹«ê¸° ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .action-btn{
      background: linear-gradient(180deg, #F7F8FA, #EFF1F5);
      color: #2E323A;
      border: 1px solid var(--line);
      box-shadow: 0 6px 14px rgba(0,0,0,.06), inset 0 1px 0 rgba(255,255,255,.9);
    }

    /* ì €ì¥ ë²„íŠ¼ë§Œ í¬ì¸íŠ¸(ì„¸ì´ì§€) */
    #save{
      background: linear-gradient(180deg, #8FBFB0, #7FAE9E);
      color: #F7F8FA;
      border: none;
      box-shadow: 0 10px 22px rgba(127,174,158,.28), inset 0 1px 0 rgba(255,255,255,.65);
    }

    /* ë‹«ê¸° ë²„íŠ¼ì€ ê³ ìŠ¤íŠ¸ ëŠë‚Œ */
    #close{
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      box-shadow: none;
    }

/* Cloud Dancer â€“ Sage ì§€ì¶œ/ìˆ˜ì… í† ê¸€ */
.segmented{
  display:flex;
  gap:12px;
  margin: 8px 0 14px;
}

.seg-btn{
  flex:1;
  height:44px;
  border-radius:14px;
  border:1px solid #D9DDE5;      /* Mist Line Gray */
  background:#EFF1F5;            /* Soft Fog Gray */
  color:#2E323A;                 /* Cloud Ink */
  font-size:14px;
  font-weight:700;
  letter-spacing:-0.2px;
  cursor:pointer;
  -webkit-appearance:none;
  appearance:none;
}

.seg-btn.active{
  background:
    linear-gradient(
      180deg,
      #F7F8FA,
      #EFF1F5
    );                            /* Cloud Dancer White â†’ Soft Fog */
  color:#2E323A;                 /* Cloud Ink */
  border-color:#7FAE9E;          /* ğŸŒ¿ Cloud Sage */
  box-shadow:
    0 6px 14px rgba(127,174,158,.28),
    inset 0 1px 0 rgba(255,255,255,.9);
}


    #monthlyTop3{
      margin-bottom: 14px; /* Top3 ì•„ë˜ ê³µê¸°ì¸µ */
    }

    #monthlySummary b{
      font-weight: 500; /* 400~600 ì‚¬ì´ë¡œ ì·¨í–¥ ì¡°ì ˆ */
    }

    #monthlyList{
      padding-bottom: 36px;
    }
    
    #memo{
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: 14px;

      font-size: 16px;
      min-height: 56px;      /* ë©”ëª¨ 2ì¤„, ì¤„ë°”ê¿ˆ ìì—°, ë¦¬ì‚¬ì´ì¦ˆ ê¸ˆì§€ */
      resize: none;
      line-height: 1.4;
      padding: 10px;
    }
    
    .type-btn {
      font-size: 13px;   /* â† ì—¬ê¸°ì„œ ì¡°ì ˆ (13~15 ì¶”ì²œ) */
      padding: 8px 14px;
    }
    
    /* iOSì—ì„œ input í´ë¦­ ì‹œ ìë™ í™•ëŒ€(zoom) ë°©ì§€ í•µì‹¬ */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* í˜¹ì‹œ ëª¨ë‹¬ ì•ˆì˜ inputë§Œ ë”°ë¡œ ì‘ê²Œ ë¨¹ëŠ” ê²½ìš° ëŒ€ë¹„ */
    .modal input, .modal select, .modal textarea {
     font-size: 16px !important;
    }

    /* ëª¨ë‹¬ textareaë§Œ ì˜ˆì˜ê²Œ */
    textarea{
      width:100%;
      background: var(--panel2);         /* âœ… íšŒìƒ‰ í†µì¼ */
      border: 1px solid var(--line);     /* âœ… ë™ì¼í•œ ë¼ì¸ */
      color: var(--text);
      padding: 10px;                     /* âœ… inputê³¼ ë™ì¼ */
      border-radius: 14px;               /* âœ… ë‘¥ê¸€ê²Œ(ë„ˆê°€ ì›í•œ 14px) */
      font-family: inherit;              /* âœ… í°íŠ¸ í†µì¼(ìê°„ ì´ìŠˆ ë°©ì§€) */
      letter-spacing: -0.2px;            /* âœ… ìê°„ í†µì¼ */
      line-height: 1.4;
      resize: none;                      /* âœ… ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì œê±° */
    }


    /* iOS Safari date input text-align fix */
    input[type="date"]{
      text-align: left;
      padding-left: 10px; /* ì™¼ìª½ìœ¼ë¡œ â€˜ë¶™ì–´ ë³´ì´ê²Œâ€™ */
    }

    input[type="date"]::-webkit-date-and-time-value{
      text-align: left;
    }
    .hidden { display: none !important; }


    #recentList{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      padding-bottom: 0 @important;
    }

    /* ìµœê·¼ë‚´ì—­ ì²« ì›” í—¤ë”ëŠ” ìœ„ ì—¬ë°± ì œê±° */
    #recentList .month-header:first-child{
      margin-top: 0;
    }
    .recent-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel2);
    }
    .recent-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .recent-date{
      font-size: 13px;
      color: var(--muted);
    }
    /* ìµœê·¼ë‚´ì—­ - ì¹´í…Œê³ ë¦¬/ì¹´ë“œ/ì‚¬ìš©ì²˜ë¥¼ ë³´ì¡° í…ìŠ¤íŠ¸ë¡œ */
    .recent-title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.2px;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:8px;
     }

    .recent-sub{
      font-size: 12px;          /* âœ… ì•„ë˜ì¤„ ì‘ê²Œ */
      color: var(--muted);
      letter-spacing: -0.2px;
    }     
    .recent-meta{
      font-size: 12px;        /* ê·¸ëŒ€ë¡œ */
      font-weight: 400;       /* ğŸ”¥ ì´ê²Œ í•µì‹¬ */
      line-height: 1.3;       /* ğŸ”¥ ì¤„ê°„ê²© ì¤„ì´ê¸° */
      letter-spacing: 0;      /* ğŸ”¥ ìê°„ ë¦¬ì…‹ */
      color:var(--muted);
    }
    .recent-amt{
      font-weight: 600;
    }


/* âœ… í™ˆ: ì›”ë³„ ì „ì²´ ë³´ê¸° ë²„íŠ¼ */
.go-monthly-btn{
  width: 100%;
  margin-top: 6px;
  height: 44px;
  border-radius: 14px;                 /* ë‘¥ê·¼ ë„¤ëª¨ */
  border: 1px solid rgba(127,174,158,.65); /* ì„¸ì´ì§€ í…Œë‘ë¦¬ */
  background: rgba(255,255,255,.92);   /* í° ë°°ê²½ */
  color: #2E323A;
  font-size: 14px;
  font-weight: 800;
  letter-spacing: -0.2px;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,.06);
}

.go-monthly-btn:active{
  transform: scale(.99);
  opacity: .92;
}
    
    

    .recent-right{
  display:flex;
  align-items:center;
  gap:10px;
}

.edit-btn{
  width:34px;
  height:34px;
  border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.65);
  color: var(--muted);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  display: none;
}

.edit-btn:active{
  transform: scale(.98);
  opacity: .9;
}

.delete-btn{
  width:34px;
  height:34px;
  border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.65);
  color: #C94A4A; /* ì§€ì¶œ ë ˆë“œ ê³„ì—´ */
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  display: none;
}

.delete-btn:active{
  transform: scale(.98);
  opacity: .9;
}
    

/* âœ… í¸ì§‘ëª¨ë“œì¼ ë•Œë§Œ ì—°í•„ ë³´ì´ê¸° */
body.edit-mode .edit-btn,
body.edit-mode .delete-btn{
  display:flex;
}


 /* âœ… í™ˆ - ì˜¤ëŠ˜ì˜ ì§€ì¶œ í•œ ì¤„ */
.today-spend{
  margin-top: 10px;      /* ëª…ì–¸ê³¼ í•œ ì¤„ ê³µê¸° */
  display: inline-flex;
  font-size: 13px;
  justify-content: space-between;
  align-items: center;
  gap: 2px;
}

.today-spend .label{
  letter-spacing: -0.2px;
  font-size: 13px;               /* ë³¸ë¬¸ê³¼ ë™ì¼ */
  color: var(--muted);
  font-weight: 400;
}

.today-spend .value{
  display: inline-flex;                 /* ê³¼í•˜ì§€ ì•Šê²Œ, ë”± ì¸ì§€ìš© */
  letter-spacing: 0px;
  font-size: 13px;               /* ë³¸ë¬¸ê³¼ ë™ì¼ */
  font-weight: 400;              /* â­ êµµê¸° í†µì¼ */
}

.today-amount{
  color: #C94A4A; /* muted red */
  margin-left: 4px;
}

/* ëŒ€ë¹„ ì •ë³´ */
.today-diff {
  margin-left: 8px;
  font-size: 13px;
  letter-spacing: -0.2px;
}

/* ì–´ì œë³´ë‹¤ ë” ì”€ */
.today-diff.up {
  color: rgba(201, 74, 74, 0.6); /* ì—°í•œ ë¡œì¦ˆ */
}

/* ì–´ì œë³´ë‹¤ ëœ ì”€ */
.today-diff.down {
  color: rgba(62, 142, 126, 0.7); /* ì„¸ì´ì§€ ê·¸ë¦° */
}
    
    

    /* ===== ì›” êµ¬ë¶„ì„ (Sticky) ===== */
    .month-header{
      position: sticky;
      top: 85px; /* âœ… ìƒë‹¨ í—¤ë” ì•„ë˜ì— ë¶™ê²Œ(í•„ìš”í•˜ë©´ 68~90 ì‚¬ì´ë¡œ ì¡°ì ˆ) */
      z-index: 6;

      display:flex;
      align-items:center;
      justify-content:space-between;

      padding:10px 12px;
      margin-top:12px;

      border:1px solid var(--line);
      border-radius:14px;

      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
    }

    .month-title{
      font-weight:800;
      letter-spacing:-0.2px;
    }

    .month-sum{
      font-size:12px;
      color:var(--muted);
      letter-spacing:-0.2px;
    }

    /* ê¸ˆì•¡ ìƒ‰ìƒ */
    .amount-expense {
      color: var(--expense-red);   /* ì§€ì¶œ */
    }
    .amount-income {
      color: var(--income-green);  /* ìˆ˜ì… */
    }

    /* ì§€ì¶œ: ì„¸ì´ì§€ì™€ ì–´ìš¸ë¦¬ëŠ” muted red */
    .amt-expense{
      color: #C94A4A;   /* ë„ˆë¬´ ì¨í•˜ì§€ ì•Šì€, íšŒê¸° ë„ëŠ” ë ˆë“œ */
    }

    /* ìˆ˜ì…: ì„¸ì´ì§€ ê³„ì—´ ê·¸ë¦° */
    .amt-income{
      color: #3E8E7E;   /* ì„¸ì´ì§€ì™€ ê°™ì€ ê³„ì—´ */
    }

    .memo-dot{
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #7FAE9E; /* ì„¸ì´ì§€ */
      display: inline-block;
      margin-left: 6px;
    }

    .month-sep{
      margin: 12px 2px 6px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: -0.2px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .month-sep::after{
      content: "";
      height: 1px;
      flex: 1;
      background: var(--line);
      opacity: .9;
    }
    
/* âœ… Toast */
.toast{
  position: fixed;
  left: 50%;
  bottom: calc(86px + env(safe-area-inset-bottom)); /* íƒ­ë°” ìœ„ */
  transform: translateX(-50%);
  z-index: 999;

  background: rgba(46,50,58,.92); /* Cloud Ink ëŠë‚Œ */
  color: #F7F8FA;
  padding: 12px 14px;
  border-radius: 14px;
  box-shadow: 0 10px 26px rgba(0,0,0,.18);
  font-size: 14px;
  letter-spacing: -0.2px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  gap: 8px;

  opacity: 0;
  pointer-events: none; /* í† ìŠ¤íŠ¸ ìì²´ëŠ” í´ë¦­ ë¬´ì‹œ */
}

/* ë‚˜íƒ€ë‚  ë•Œ */
.toast.show{
  opacity: 1;
  animation: toastIn .18s ease-out;
}

/* ì‚¬ë¼ì§ˆ ë•Œ */
.toast.hide{
  animation: toastOut .18s ease-in forwards;
}

.toast.hidden{ display:none !important; }

.toast-undo{
  border: 1px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.10);
  color: #F7F8FA;
  padding: 8px 10px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  pointer-events: auto; /* âœ… ë²„íŠ¼ë§Œ í´ë¦­ ê°€ëŠ¥ */
}



    body.modal-open{
      overflow: hidden;
      touch-action: none;
    }




/* ===== í†µê³„(ë„ë„›/ë§‰ëŒ€) ===== */
.donut{
  width:140px;
  height:140px;
}

/* âœ… ë„ë„› ì¤‘ì•™ ë¼ë²¨(ê³ ì • í¬ê¸°: 2,000,000ì›ë„ ë“¤ì–´ê°€ê²Œ) */
.donut-center{
  font-family: inherit;
  fill: rgba(17,17,17,.9);
  text-anchor: middle;
  dominant-baseline: middle;
}

.donut-center .ym{
  font-size: 10px;            /* ì›”ì€ ë” ì‘ê²Œ */
  fill: rgba(17,17,17,.55);
  letter-spacing: -0.2px;
}

.donut-center .total{
  font-size: 12px;            /* ê¸ˆì•¡ì€ ê³ ì • 12px */
  font-weight: 800;
  letter-spacing: -0.3px;
}

    

    
.bar-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin:10px 0;
}

.bar-name{
  width:72px;
  font-size:13px;
  color:var(--muted);
  letter-spacing:-0.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.bar-track{
  flex:1;
  height:10px;
  border-radius:999px;
  background: rgba(0,0,0,.06);
  overflow:hidden;
}

.bar-fill{
  height:100%;
  border-radius:999px;
  width:0%;
  filter: saturate(.9) brightness(1.02);
}

.bar-amt{
  width:90px;
  text-align:right;
  font-size:13px;
  color:var(--text);
}

/* âœ… í†µê³„ íƒ­: í˜ì´ë“œ + 4px ë¯¸ì„¸ ì´ë™ */
#statsDonutWrap.anim-in,
#statsTop5.anim-in{
  animation: statsPop .36s ease-out both;
  will-change: opacity, transform;
}

@keyframes statsPop{
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}    

@keyframes toastIn{
  from { transform: translateX(-50%) translateY(8px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
@keyframes toastOut{
  from { transform: translateX(-50%) translateY(0); opacity: 1; }
  to   { transform: translateX(-50%) translateY(8px); opacity: 0; }
}
    


    .memo-slide{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
  z-index: 30;
  display: flex;
  align-items: flex-end;
}

.memo-slide.hidden{
  display: none;
}

    #memoSlideTitle{
      font-size: 14px;        /* â¬… ì§€ê¸ˆë³´ë‹¤ ì¤„ì´ê¸° */
      font-weight: 700;       /* â¬… bold ë§ê³  semi-bold */
      line-height: 1.35;
    }
    
.memo-sheet{
  width: 100%;
  background: var(--panel);
  border-radius: 20px 20px 0 0;
  padding: 20px 20px 28px; 
  animation: memoUp .22s ease-out;
}

@keyframes memoUp{
  from{ transform: translateY(100%); }
  to{ transform: translateY(0); }
}

.memo-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 5px;

  /* âœ… ë°•ìŠ¤ê° ì œê±° */
  border: none;
  background: transparent;
  border-radius: 0;
  padding-bottom: 6px;

  /* âœ… íƒ€ì´í¬ê·¸ë˜í”¼ë§Œ ë‚¨ê¸°ê¸° */
  color: var(--text);
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.2px;
}
    

.memo-meta{
  margin-top: 2px;
  margin-bottom: 14px;
  font-size: 13px;
  color: #6b7280;    /* muted gray */
  letter-spacing: -0.2px;
}

.memo-content{
  margin-top: 14px;
  padding-bottom: 8px;
  font-size: 15px;
  line-height: 1.6;
  white-space: pre-wrap;
}

    
    #memoSlideClose{
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 999px;
      background: rgba(127,174,158,.35); /* âœ… ì—°í•œ ì„¸ì´ì§€ */
      color: #F7F8FA;                    /* âœ… X í°ìƒ‰ */
      
      padding: 4px 8px;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      font-size: 18px;
      font-weight: 500;
      line-height: 1;
      
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }
    
    #memoSlideClose:active{
      transform: scale(.96);
      opacity: .85;
    }

    /* =========================
   ğŸ“ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ì—´ê¸° (ì›”ë³„ í•­ëª© í´ë¦­)
   ========================= */
document.getElementById("monthlyList")?.addEventListener("click", (e)=>{
  if(document.body.classList.contains("edit-mode")) return;
  
  const itemEl = e.target.closest(".recent-item");
  if(!itemEl) return;

  const id = itemEl.dataset.id;
  if(!id) return;

  const item = loadRecords().find(r => r.id === id);
  if(!item) return;

  openMemoSlide(item);
});

    

    /* âœ… ì›”ë³„ í•„í„° UI */
.filter-row{
  display:flex;
  gap:10px;
  margin-top:10px;
  align-items:center;
}

.filter-chip-group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.chip{
  border:1px solid var(--line);
  background: var(--panel2);
  color: var(--muted);
  padding:8px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 700;
  cursor:pointer;
}

.chip.active{
  background: rgba(127,174,158,.18);
  border-color: rgba(127,174,158,.55);
  color: var(--text);
}

#monthlyFilterCard select{
  flex:1;
  min-width: 0;
}

    #page-monthly{
      padding-bottom: 0;
  }


    /* âœ… ì¹´ë“œ ì•ˆì— ë“¤ì–´ê°„ í•„í„°ë°” ë²„ì „ */
.mbar.in-card{
  position: static;         /* sticky ì œê±° */
  top: auto;
  z-index: auto;

  margin: 10px 0 8px;       /* TOP3 ì•„ë˜ ê³µê¸° */
  padding: 0;

  border: none;
  border-radius: 0;
  background: transparent; /* âœ… ê°ì‹¸ëŠ” ë°•ìŠ¤ ëŠë‚Œ ì œê±° */
  backdrop-filter: none;
  
  display:flex;
  gap:8px;
  align-items:center;

  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
}
.mbar.in-card::-webkit-scrollbar{ display:none; }

.mbar-panel.in-card{
  margin: 6px 0 12px;
}


    #homeRecentCard{
      padding-bottom: 44px; /* âœ… ì§€ê¸ˆì˜ 1/2 ëŠë‚Œ: 36~52 ì‚¬ì´ê°€ ì˜ˆì¨ */
    }
    
    #goMonthlyBtn{
      margin-top: 10px;  /* âœ… ë¦¬ìŠ¤íŠ¸ ì•„ë˜ 6~12px ì¶”ì²œ */
    }
    
    /* âœ… ì›”ë³„ mbar ì¹© */
.mchip{
  border:1px solid var(--line);
  background: var(--panel2);
  color: var(--muted);
  padding:8px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:800;
  cursor:pointer;
  white-space:nowrap;
  flex: 0 0 auto;
}

.mchip.active{
  background: rgba(127,174,158,.18);
  border-color: rgba(127,174,158,.55);
  color: var(--text);
}

.mchip.ghost{
  background: transparent;
}

.mchip .caret{
  margin-left: 4px;
  opacity: .7;
}

    /* âœ… ì›”ë³„: í•„í„° ê²°ê³¼ ì—†ìŒ ë¬¸êµ¬ ê°„ê²© í¬ê²Œ */
  #monthlyList .monthly-empty{
    margin-top: 36px;
    text-align: center;
    opacity: .9;
  }    
    
    
  </style>
</head>

<body>
  <header class="header">
    <div class="title">
  <h1>ë‚‘ê°± ê°€ê³„ë¶€</h1>
  <div style="display:flex; gap:8px; align-items:center;">
    <span class="pill">ë¡œì»¬ì €ì¥(ë‚´ í°ì—ë§Œ)</span>
    <button id="toggleEdit" type="button" class="pill" style="cursor:pointer;">í¸ì§‘</button>
  </div>
</div>
    <div class="subtitle">í•˜ë‹¨ íƒ­ìœ¼ë¡œ ì´ë™ Â· í™ˆì—ì„œ +ë¡œ ì…ë ¥(ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì„)</div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section class="page active" id="page-home">
      <div class="card">
        <h2>í™ˆ</h2>
        <p class="hint">
          ì˜¤ëŠ˜ ì“´ ëˆì„ ì•„ëŠ” ê²ƒë§Œìœ¼ë¡œ ì¶©ë¶„í•˜ë‹¤.<br/>
          ì‘ì‹¬ì‚¼ì¼ì´ë©´, 1ë…„ì— 120ë²ˆì´ë‹¤.
        </p>
        <div class="today-spend" id="todaySpendRow">
          <span class="label">ì˜¤ëŠ˜ì˜ ì§€ì¶œ :</span>
          <span class="value amt-expense" id="todaySpendValue">0ì›</span>
          <span class="today-diff" id="todayDiff"></span>
        </div>
      </div>

      <div class="card" id="homeRecentCard">
        <h2>ìµœê·¼ ë‚´ì—­</h2>
        <div id="recentList"></div>

        <!-- âœ… ì›”ë³„ ì „ì²´ ë³´ê¸° ë²„íŠ¼ -->
        <button id="goMonthlyBtn" type="button" class="go-monthly-btn">
          ì›”ë³„ì—ì„œ ì „ì²´ ë³´ê¸° â†’
        </button>
      </div>
      
    </section>

    <!-- STATS -->
    <section class="page" id="page-stats">
      <div class="card">
        <h2>í†µê³„</h2>
        <p class="hint">ì´ë²ˆ ë‹¬ ì¹´í…Œê³ ë¦¬ ë¹„ì¤‘</p>

        <!-- âœ… ë„ë„› + ìš”ì•½ -->
        <div id="statsDonutWrap" style="display:flex; gap:14px; align-items:center; margin-top:12px;">
          <div id="statsDonut"></div>

          <div style="flex:1;">
            <div class="hint" style="margin-bottom:8px;">ì´ ì§€ì¶œ</div>
            <div id="statsTotalExpense" style="font-size:18px; font-weight:700;">0ì›</div>
            <div id="statsTop1" class="hint" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>TOP5</h2>
        <div id="statsTop5"></div>
      </div>
    </section>
    
    
    <!-- BUDGET -->
    <section class="page" id="page-budget">
      <div class="card">
        <h2>ì˜ˆì‚°</h2>
        <p class="hint">
          ì´ ìƒí™œë¹„ / ì‹ë¹„ / ìƒí•„í’ˆ / ì·¨ë¯¸ ì˜ˆì‚°ì„ ì„¤ì •í•˜ê³ <br/>
          ëª©í‘œ ëŒ€ë¹„ ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
        </p>
      </div>
      
      <div class="card">
        <h2>ì´ë²ˆ ë‹¬ ì˜ˆì‚°</h2>
        <div class="row">
          <label>ì‹ë¹„</label>
          <input type="text" placeholder="ì˜ˆ: 600,000ì›" disabled />
        </div>

        <div class="row">
          <label>ìƒí™œë¹„</label>
          <input type="text" placeholder="ì˜ˆ: 400,000ì›" disabled />
        </div>

        <div class="row">
          <label>ì·¨ë¯¸ / ì—¬ê°€</label>
          <input type="text" placeholder="ì˜ˆ: 200,000ì›" disabled />
        </div>

        <p class="hint">
        â€» ì˜¤ëŠ˜ì€ UIë§Œ. ì…ë ¥/ê³„ì‚°ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì—°ê²°í• ê²Œìš”.
        </p>
      </div>
    </section>

    <!-- MONTHLY -->
    <section class="page" id="page-monthly">
      <div class="card">
        <h2>ì›”ë³„</h2>
        <p class="hint">
          ì›” ì„ íƒ â†’ í•´ë‹¹ ì›” ì§€ì¶œ/ìˆ˜ì… ë¦¬ìŠ¤íŠ¸ + í•©ê³„ ìë¦¬.
        </p>
      </div>

    <!-- âœ… ì›” ì„ íƒ ì¹´ë“œ -->
    <div class="card">
      <h2>ì›” ì„ íƒ</h2>
      <div class="row">
        <select id="monthSelect"></select>
      </div>
    </div>

  

      
<div class="card">
  <h2 id="monthlyTitle">ì´ë²ˆ ë‹¬</h2>
  <p class="hint" id="monthlySummary"></p>

  <!-- TOP3 -->
  <div id="monthlyTop3" class="hint" style="margin-top:10px;"></div>

  <!-- âœ… ì—¬ê¸°! TOP3 ì•„ë˜ì— í•„í„°ë°” (ì¹´ë“œ ì•ˆ) -->
  <div class="mbar in-card" id="monthlyBar">
    <button type="button" class="mchip active" data-type="all">ì „ì²´</button>
    <button type="button" class="mchip" data-type="expense">ì§€ì¶œ</button>
    <button type="button" class="mchip" data-type="income">ìˆ˜ì…</button>

    <button type="button" class="mchip mchip-dd" id="mbarCategoryBtn">
      ì¹´í…Œê³ ë¦¬ <span class="caret">â–¾</span>
    </button>
    <button type="button" class="mchip mchip-dd" id="mbarCardBtn">
      ì¹´ë“œ <span class="caret">â–¾</span>
    </button>
    <button type="button" class="mchip mchip-dd" id="mbarSearchBtn">
      ê²€ìƒ‰ <span class="caret">â–¾</span>
    </button>

    <button type="button" class="mchip ghost" id="mbarReset">ì´ˆê¸°í™”</button>
  </div>

  <!-- âœ… í•„í„° ëˆ„ë¥´ë©´ ì—¬ê¸° ì‘ì€ íŒ¨ë„ì´ ì¹´ë“œ ì•ˆì—ì„œ ì—´ë¦¼ -->
  <div class="mbar-panel hidden in-card" id="mbarPanel"></div>

  <!-- ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
  <div id="monthlyList"></div>
</div>
      
  </section>
  </main>

  <!-- Floating + button (Home only) -->
  <button class="fab" id="fab" type="button"><span>+</span></button>
  <div class="modal hidden" id="modal">
  <div class="sheet">
    <h3>ì§€ì¶œ / ìˆ˜ì… ì¶”ê°€</h3>

    <div class="row">
      <label class="label">êµ¬ë¶„</label>

        <div class="segmented" id="typeSegment" role="group" aria-label="ì§€ì¶œ ìˆ˜ì… ì„ íƒ">
          <button type="button" class="seg-btn active" data-value="expense">ì§€ì¶œ</button>
          <button type="button" class="seg-btn" data-value="income">ìˆ˜ì…</button>
        </div>

      <!-- ì‹¤ì œ ì €ì¥ê°’ì„ ë‹´ëŠ” ìˆ¨ê²¨ì§„ input -->
      <input type="hidden" id="type" value="expense" />
    </div>

    <div class="row">
      <label>ë‚ ì§œ</label>
      <input type="date" id="spentDate" />
    </div>

    <div class="row">
  <label>ê¸ˆì•¡</label>
  <input type="text" id="amount" placeholder="ê¸ˆì•¡ ì…ë ¥" inputmode="numeric" autocomplete="off" />
</div>

    <div class="row">
      <label>ì¹´í…Œê³ ë¦¬</label>
      <select id="category"></select>
    </div>

    <div class="row">
      <label>ì‚¬ìš©ì²˜</label>
      <input id="place" placeholder="ì´ë§ˆíŠ¸ / ì¿ íŒ¡ / ì»¬ë¦¬ / ë„¤ì´ë²„ / í¸ì˜ì  / ë§ˆíŠ¸ / ê¸°íƒ€" />
    </div>

    <div class="row">
      <label>ë©”ëª¨(ë¹„ê³ )</label>
      <textarea id="memo" placeholder="ì´ìœ  / ëª©ì  / ëŠë‚Œ ì ì–´ë‘ê¸°"></textarea>
    </div>
    
    <div class="row">
      <label>ì¹´ë“œ</label>
      <select id="card">
        <option>ì‚¼ì„±</option>
        <option>ì‹ í•œ</option>
        <option>êµ­ë¯¼</option>
        <option>í˜„ê¸ˆ/ê³„ì¢Œ</option>
      </select>
    </div>

    <div class="actions">
      <button class="action-btn" id="save">ì €ì¥</button>
      <button class="action-btn" id="close">ë‹«ê¸°</button>
    </div>
  </div>
</div>
  <!-- Bottom tabs -->
  <nav class="tabbar" role="tablist" aria-label="í•˜ë‹¨ íƒ­">
    <button class="tab active" data-target="home" role="tab" aria-selected="true">
      <div class="icon">ğŸ </div>
      <div>í™ˆ</div>
    </button>
    <button class="tab" data-target="stats" role="tab" aria-selected="false">
      <div class="icon">ğŸ“Š</div>
      <div>í†µê³„</div>
    </button>
    <button class="tab" data-target="budget" role="tab" aria-selected="false">
      <div class="icon">ğŸ¯</div>
      <div>ì˜ˆì‚°</div>
    </button>
    <button class="tab" data-target="monthly" role="tab" aria-selected="false">
      <div class="icon">ğŸ—“ï¸</div>
      <div>ì›”ë³„</div>
    </button>
  </nav>

  <!-- âœ… Toast (script ìœ„ë¡œ ì´ë™) -->
  <div id="toast" class="toast hidden" role="status" aria-live="polite">
    <span id="toastText"></span>
    <button id="toastUndo" type="button" class="toast-undo" style="display:none;">
    ë˜ëŒë¦¬ê¸°
    </button>
  </div>

  <!-- ğŸ“ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ -->
  <div id="memoSlide" class="memo-slide hidden">
    <div class="memo-sheet">
      <div class="memo-header">
        <span id="memoSlideTitle"></span>
        <button id="memoSlideClose" aria-label="ë‹«ê¸°">Ã—</button>
      </div>

      <div class="memo-meta" id="memoSlideMeta"></div>

      <div class="memo-content" id="memoSlideContent">
        ë©”ëª¨ ë‚´ìš©
      </div>
    </div>
  </div>
  

  <script>

  window.addEventListener("error", (e) => {
  console.error("ğŸ’¥ JS Error:", e.message, e.filename, e.lineno, e.colno);
  });
  window.addEventListener("unhandledrejection", (e) => {
  console.error("ğŸ’¥ Promise rejection:", e.reason);
  });

    
    // íƒ­ ì „í™˜
    const tabs = document.querySelectorAll('.tab');
    const pages = {
      home: document.getElementById('page-home'),
      stats: document.getElementById('page-stats'),
      budget: document.getElementById('page-budget'), // âœ… ì¶”ê°€
      monthly: document.getElementById('page-monthly'),
    };
    const fab = document.getElementById('fab');


function setActiveTab(target){
  // pages
  Object.entries(pages).forEach(([key, el])=>{
    el.classList.toggle('active', key === target);
  });

  // tabs
  tabs.forEach(t=>{
    const isActive = t.dataset.target === target;
    t.classList.toggle('active', isActive);
    t.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });

  // + ë²„íŠ¼ì€ í™ˆì—ì„œë§Œ ë³´ì´ê¸°
  fab.classList.toggle('hidden', target !== 'home');

  // âœ… í†µê³„ íƒ­ ë“¤ì–´ê°ˆ ë•Œë§ˆë‹¤ ìµœì‹  ë°˜ì˜
  if(target === "stats") renderStats();

  // âœ… í†µê³„ íƒ­ ì§„ì… ì• ë‹ˆë©”ì´ì…˜
  if(target === "stats"){
    const a = document.getElementById("statsDonutWrap");
    const b = document.getElementById("statsTop5");

    [a,b].forEach(el=>{
      if(!el) return;
      el.classList.remove("anim-in");
      void el.offsetWidth;
      el.classList.add("anim-in");
    });
  }

  // âœ… ì›”ë³„ íƒ­ ë“¤ì–´ê°ˆ ë•Œ: í•„í„° UI ë™ê¸°í™” + ì›” ë Œë”
  if(target === "monthly"){
    syncMonthlyBarUI(); // âœ… ì¶”ê°€
    
    const select = document.getElementById("monthSelect");
    if(select && select.value){
      renderMonthly(select.value);
    }else{
      renderMonthSelect();
      const select2 = document.getElementById("monthSelect");
      if(select2 && select2.value){
        renderMonthly(select2.value);
      }
    }
  }

  if(target === "monthly"){
  syncMonthlyBarUI();

  renderMonthSelect();              // âœ… ë¬´ì¡°ê±´ ì…€ë ‰íŠ¸ ë¨¼ì € ì±„ì›€
  const s = document.getElementById("monthSelect");
  renderMonthly(s?.value || currentYM());  // âœ… ë¬´ì¡°ê±´ í•œ ë²ˆ ë Œë”
  }

}

    
tabs.forEach(t=>{
  t.addEventListener('click', ()=> setActiveTab(t.dataset.target));
});

    
// âœ… í¸ì§‘ëª¨ë“œ í† ê¸€
const toggleEditBtn = document.getElementById("toggleEdit");

toggleEditBtn?.addEventListener("click", () => {
  const on = document.body.classList.toggle("edit-mode");
  toggleEditBtn.textContent = on ? "ì™„ë£Œ" : "í¸ì§‘";

  // âœ… í¸ì§‘ëª¨ë“œ OFFë¡œ ëŒì•„ê°ˆ ë•Œ: ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/ìˆ˜ì •ìƒíƒœ ì •ë¦¬(ì„ íƒì´ì§€ë§Œ ê°•ì¶”)
  if (!on) {
    modal?.classList.add("hidden");
    document.body.classList.remove("modal-open"); // í˜¹ì‹œ ì—´ë¦° ìƒíƒœì˜€ë‹¤ë©´ ì•ˆì „ë¹µ

    editingId = null;
    saveBtn.textContent = "ì €ì¥"; // âœ… ë¼ë²¨ ì›ë³µ
    
    // í¼ë„ ì´ˆê¸°í™”(ì›í•˜ë©´)
    // resetFormToNew?.();
    // resetForm?.();
  }
});
    
    
// ===== ì¹´í…Œê³ ë¦¬(ì´ˆê¸°ê°’: ë‚˜ì¤‘ì— ì–¸ì œë“  ì¶”ê°€ ê°€ëŠ¥) =====
const CATEGORIES = [
  "ì‹ë¹„",
  "ì™¸ì‹/ë°°ë‹¬",
  "ì»¤í”¼/ê°„ì‹",
  "ìƒí•„í’ˆ",
  "ìƒí™œì„œë¹„ìŠ¤",
  "êµ¬ë…/ì •ê¸°ê²°ì œ",
  "ì˜ë¥˜/ì¡í™”",
  "ì•„ì´ìš©í’ˆ",
  "ì•„ì´ì˜ë¥˜",
  "êµìœ¡/ì²´í—˜",
  "ë³´í—˜ë£Œ",
  "ê³µê³¼ê¸ˆ",
  "ê±´ê°•ë³´í—˜ë£Œ",
  "ìŠ¤í† ì–´ìˆ˜ì…(ì •ì‚°)",
  "ìƒí’ˆë§¤ì…ë¹„",
  "ì¬ë£ŒÂ·ì œì‘ë¹„",
  "ë°°ì†¡/íƒë°°ë¹„",
  "ìŠ¤í† ì–´ë¹„ìš©",
  "ê¸°íƒ€"
];

const modal = document.getElementById('modal');
const closeBtn = document.getElementById('close');
const saveBtn = document.getElementById('save');

/* ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° */
modal.addEventListener("click", (e) => {
  if (e.target === modal) {
    editingId = null;    // ìˆ˜ì • ì¤‘ì´ë©´ ì´ˆê¸°í™”
    closeModal();
  }
});

    
const typeEl = document.getElementById('type');
const amountEl = document.getElementById('amount');
const categoryEl = document.getElementById('category');
const placeEl = document.getElementById('place');
const cardEl = document.getElementById('card');
const spentDateEl = document.getElementById('spentDate');
const memoEl = document.getElementById('memo'); // âœ… ì¶”ê°€!
    
function renderCategories(){
  categoryEl.innerHTML = "";
  CATEGORIES.forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    categoryEl.appendChild(opt);
  });
}
renderCategories();

function openModal(){
  modal.classList.remove('hidden');
  document.body.classList.add('modal-open');
}

function closeModal(){
  modal.classList.add('hidden');
  document.body.classList.remove('modal-open');
}

    
function resetFormToNew(){
  editingId = null;
  saveBtn.textContent = "ì €ì¥";

  typeEl.value = "expense";
  const seg = document.getElementById('typeSegment');
  if(seg){
    seg.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    seg.querySelector('.seg-btn[data-value="expense"]')?.classList.add('active');
  }

  spentDateEl.value = localISODate(new Date());

  amountEl.value = "";
  amountEl.dataset.raw = "";
  categoryEl.value = CATEGORIES[0] || "ê¸°íƒ€";
  placeEl.value = "";
  memoEl.value = "";
  cardEl.value = "ì‚¼ì„±";
}

    
function fillFormForEdit(item){
  editingId = item.id;
  saveBtn.textContent = "ìˆ˜ì • ì €ì¥";

  typeEl.value = item.type || "expense";
  const seg = document.getElementById('typeSegment');
  if(seg){
    seg.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    seg.querySelector(`.seg-btn[data-value="${typeEl.value}"]`)?.classList.add('active');
  }

  spentDateEl.value = item.spentDate || localISODate(new Date());

  const raw = String(item.amount || 0).replace(/[^0-9]/g,"");
  amountEl.dataset.raw = raw;
  amountEl.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  categoryEl.value = item.category || "ê¸°íƒ€";
  placeEl.value = item.place || "";
  memoEl.value = item.memo || "";
  cardEl.value = item.card || "ì‚¼ì„±";
}
    
    
// + ë²„íŠ¼ â†’ ëª¨ë‹¬ ì—´ê¸°
fab.addEventListener('click', ()=>{
  resetFormToNew();
  openModal();
  amountEl.focus();
});
    
// ë‹«ê¸°
closeBtn.addEventListener('click', ()=>{
  editingId = null; // âœ… ìˆ˜ì • ì·¨ì†Œ
  closeModal();
});



    
// ì €ì¥(ì¼ë‹¨ ë¡œì»¬ ì €ì¥ë§Œ)
// âœ… ì „ì—­ ìƒíƒœ: ìˆ˜ì • ì¤‘ì¸ record id (ì—†ìœ¼ë©´ ì‹ ê·œ ì¶”ê°€)
let editingId = null;




    
    
    
// âœ… ì €ì¥(ì¶”ê°€/ìˆ˜ì • ê²¸ìš©) â€” ìµœì¢…ë³¸
saveBtn.addEventListener('click', ()=>{
  const amount = Number(amountEl.dataset.raw || 0);
  if(!amount || amount <= 0){
    alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì¤˜!');
    return;
  }

  const list = loadRecords(); // âœ… ë„ˆê°€ ì´ë¯¸ ë§Œë“  í•¨ìˆ˜ ì‚¬ìš©

  // âœ… ê³µí†µ payload (id/createdAt ì œì™¸)
  const payload = {
    type: typeEl.value,
    amount,
    category: categoryEl.value,
    place: placeEl.value.trim(),
    card: cardEl.value,
    memo: (memoEl.value || "").trim(),
    spentDate: spentDateEl.value || new Date().toISOString().slice(0,10),
  };

  if(editingId){
    // âœ… ìˆ˜ì • ëª¨ë“œ
    const idx = list.findIndex(x => x.id === editingId);
    if(idx < 0){
      alert("ìˆ˜ì •í•  í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆì–´ ğŸ˜µ");
      return;
    }

    list[idx] = {
      ...list[idx],     // id, createdAt ìœ ì§€
      ...payload,
      updatedAt: new Date().toISOString()
    };

    editingId = null; // âœ… ìˆ˜ì • ëë‚¬ìœ¼ë‹ˆ ì´ˆê¸°í™”
    localStorage.setItem('records', JSON.stringify(list));
    renderRecent();
    resetFormToNew(); // ì„ íƒ: ë‹¤ìŒ ì˜¤í”ˆ ëŒ€ë¹„
    closeModal();
    showToast("ìˆ˜ì •ë¨ âœ“");
    return;
  }

  // âœ… ì‹ ê·œ ì¶”ê°€
  const item = {
    id: (crypto?.randomUUID?.() || ("id_" + Date.now() + "_" + Math.random().toString(16).slice(2))),
    ...payload,
    createdAt: new Date().toISOString()
  };

  list.unshift(item);
  localStorage.setItem('records', JSON.stringify(list));
  renderRecent();
  resetFormToNew(); // í†µì¼
  closeModal();
  showToast("ì €ì¥ë¨ âœ“");
});



// âœ… (ì¤‘ìš”) ë¡œì»¬ ë‚ ì§œ(ë‚´ í° ê¸°ì¤€)ë¡œ YYYY-MM-DD ë§Œë“¤ê¸°
function localISODate(d = new Date()){
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tz).toISOString().slice(0,10);
}

// âœ… ì–´ë–¤ í¬ë§·ì´ ì™€ë„ YYYY-MM-DDë¡œ ìµœëŒ€í•œ ì •ê·œí™”
function normalizeISODate(input){
  const s = String(input || "").trim();
  if(!s) return "";

  // ì´ë¯¸ ISOë©´ ê·¸ëŒ€ë¡œ
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // 2026.02.03 / 2026. 02. 03. / 2026/02/03 ê°™ì€ ê²ƒë“¤ ì²˜ë¦¬
  const m = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
  if(m){
    const y = m[1];
    const mo = String(m[2]).padStart(2,"0");
    const d  = String(m[3]).padStart(2,"0");
    return `${y}-${mo}-${d}`;
  }

  return ""; // ëª» ê³ ì¹˜ë©´ ë¹ˆê°’
}

function ymFromDateStr(dateStr){
  const iso = normalizeISODate(dateStr);
  return iso ? iso.slice(0,7) : "";
}

    
// âœ… ì˜¤ëŠ˜ ì§€ì¶œ + ì–´ì œ ëŒ€ë¹„/ë¬´ì§€ì¶œ ë¬¸êµ¬ê¹Œì§€ í•œ ë°©ì— ì²˜ë¦¬
function renderTodaySpend(){
  const valueEl = document.getElementById("todaySpendValue");
  const diffEl  = document.getElementById("todayDiff");
  if(!valueEl) return;

  const today = localISODate(new Date());
  const ydayDate = new Date();
  ydayDate.setDate(ydayDate.getDate() - 1);
  const yday = localISODate(ydayDate);

  const list = loadRecords();

  const sumExpenseByDate = (dateStr) => {
    return list.reduce((acc, x) => {
      const d = (x.spentDate || "").slice(0,10);
      const isExpense = (x.type || "expense") !== "income";
      if(d === dateStr && isExpense) acc += Number(x.amount || 0);
      return acc;
    }, 0);
  };

  const todaySum = sumExpenseByDate(today);
  const ydaySum  = sumExpenseByDate(yday);

  // 1) ì˜¤ëŠ˜ ì§€ì¶œ ê°’
  valueEl.textContent = fmtKRW(todaySum);

  // 2) ì–´ì œ ëŒ€ë¹„ ë¬¸êµ¬(ì˜†ì—)
  if(!diffEl) return;

  diffEl.classList.remove("up", "down");
  diffEl.textContent = "";

  // âœ… ë¬´ì§€ì¶œ ì„±ê³µ
  if(todaySum === 0){
    diffEl.textContent = "ë¬´ì§€ì¶œ ì„±ê³µ! ğŸ‰";
    // ìƒ‰ì€ ì¤‘ë¦½/ì´ˆë¡ ëŠë‚Œìœ¼ë¡œ í•˜ê³  ì‹¶ìœ¼ë©´ down í´ë˜ìŠ¤ ì¤˜ë„ ë¨
    diffEl.classList.add("down");
    return;
  }

  const diff = todaySum - ydaySum;

  if(diff > 0){
    diffEl.classList.add("up");
    diffEl.textContent = `â–²${Number(diff).toLocaleString("ko-KR")}`;
    return;
  }

  if(diff < 0){
    diffEl.classList.add("down");
    diffEl.textContent = `â–¼${Number(Math.abs(diff)).toLocaleString("ko-KR")}`;
    return;
  }

  // diff === 0 (ì˜¤ëŠ˜ ì§€ì¶œì´ 0ì´ ì•„ë‹Œ ìƒíƒœ)
  diffEl.textContent = "ì–´ì œì™€ ê°™ìŒ";
}

    

    

  // ì§€ì¶œ/ìˆ˜ì… ë²„íŠ¼ í† ê¸€
(function(){
  const seg = document.getElementById('typeSegment');
  const hiddenType = document.getElementById('type');
  if(!seg || !hiddenType) return;

  seg.addEventListener('click', (e) => {
    const btn = e.target.closest('.seg-btn');
    if(!btn) return;

    seg.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    hiddenType.value = btn.dataset.value; // expense | income
  });
})();

// ê¸ˆì•¡ ìë™ ì½¤ë§ˆ í‘œì‹œ + ìˆ«ìë§Œ ì €ì¥
(function(){
  const amountInput = document.getElementById('amount');
  if(!amountInput) return;


  amountEl.addEventListener('input', () => {
  const digits = amountEl.value.replace(/[^0-9]/g, '');
  amountEl.dataset.raw = digits;
  amountEl.value = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  });
})();


// recordsë¥¼ ì½ì–´ì„œ í™”ë©´ì— ë¿Œë¦¬ê¸°    
function fmtKRW(n){
  return Number(n || 0).toLocaleString("ko-KR") + "ì›";
}

function loadRecords(){
  const list = JSON.parse(localStorage.getItem("records") || "[]");

  // âœ… spentDate ì •ê·œí™” + ì €ì¥ì†Œì—ë„ ë°˜ì˜(í•œ ë²ˆë§Œ)
  let changed = false;
  list.forEach(r=>{
    const fixed = normalizeISODate(r.spentDate);
    if(fixed && fixed !== r.spentDate){
      r.spentDate = fixed;
      changed = true;
    }
  });
  if(changed){
    localStorage.setItem("records", JSON.stringify(list));
  }

  return list;
}

    
/* =========================
   ğŸ“ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ
   ========================= */

const memoSlide = document.getElementById("memoSlide");
const memoTitle = document.getElementById("memoSlideTitle");
const memoMeta  = document.getElementById("memoSlideMeta");
const memoBody  = document.getElementById("memoSlideContent");

function closeMemoSlide(){
  memoSlide.classList.add("hidden");
  document.body.classList.remove("modal-open"); // âœ… ë’¤ ìŠ¤í¬ë¡¤ ë§‰ì•˜ë˜ ê±° í•´ì œ
}
    
function openMemoSlide(item){
  // âœ… ë©”ëª¨ ì—†ìœ¼ë©´ ì•„ì˜ˆ ì—´ì§€ ì•Šê¸° (ë¨¼ì €)
  if(!(item.memo || "").trim()) return;

  memoTitle.textContent = item.category || "ë©”ëª¨";
  memoMeta.textContent =
    `${item.spentDate} Â· ${item.card || ""} Â· ${item.place || ""}`;

  memoBody.textContent = item.memo.trim();

  document.body.classList.add("modal-open");
  memoSlide.classList.remove("hidden");
}
    
    
// âœ… ë‹«ê¸° ë²„íŠ¼
document.getElementById("memoSlideClose")?.addEventListener("click", ()=>{
  closeMemoSlide();
});

// âœ… ë°°ê²½ ëˆŒëŸ¬ì„œ ë‹«ê¸°
memoSlide?.addEventListener("click", (e)=>{
  if(e.target === memoSlide){
    closeMemoSlide();
  }
});    
    
    
    
/* =========================
   ğŸ“… ì›” ì„ íƒ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
   ========================= */
function renderMonthSelect(){
  const select = document.getElementById("monthSelect");
  const listEl = document.getElementById("monthlyList");
  const titleEl = document.getElementById("monthlyTitle");
  const summaryEl = document.getElementById("monthlySummary");
  const top3El = document.getElementById("monthlyTop3");
  if(!select) return;

  const records = loadRecords();

  const months = [...new Set(
    records.map(r => ymFromDateStr(r.spentDate)).filter(Boolean)
  )].sort().reverse();

  // âœ… ê¸°ë¡ì´ ì•„ì˜ˆ ì—†ì„ ë•Œë„ ì›”ë³„ íƒ­ì´ "ë¹ˆ í™”ë©´"ì´ ë˜ì§€ ì•Šê²Œ
  if(months.length === 0){
    select.innerHTML = `<option value="${currentYM()}">${currentYM().replace("-", "ë…„ ")}ì›”</option>`;
    select.value = currentYM();

    if(titleEl) titleEl.textContent = `${currentYM().slice(0,4)}ë…„ ${currentYM().slice(5)}ì›”`;
    if(summaryEl) summaryEl.textContent = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. í™ˆì—ì„œ +ë¡œ ì¶”ê°€í•´ë´!";
    if(top3El) top3El.textContent = "";
    if(listEl) listEl.innerHTML = `<p class="hint">ì´ ë‹¬ ê¸°ë¡ì´ ì—†ì–´. +ë¡œ ì¶”ê°€í•´ë´!</p>`;
    return;
  }

  select.innerHTML = months.map(m =>
    `<option value="${m}">${m.replace("-", "ë…„ ")}ì›”</option>`
  ).join("");

  select.value = months[0];
  renderMonthly(months[0]);
}

    

   /* =========================
   ğŸ—“ï¸ ì›”ë³„ ë Œë”ë§ (ì§€ì¶œ/ìˆ˜ì…/í‰ê· /ë¬´ì§€ì¶œ + TOP3)
   ========================= */
function renderMonthly(ym){ // ym: "YYYY-MM"
  const titleEl = document.getElementById("monthlyTitle");
  const summaryEl = document.getElementById("monthlySummary");
  const top3El = document.getElementById("monthlyTop3");
  const listEl = document.getElementById("monthlyList");
  if(!titleEl || !summaryEl || !listEl) return;

  const records = loadRecords();

  // 1) í•´ë‹¹ ì›” ë°ì´í„°ë§Œ
  const monthItems = records
    .filter(r => ymFromDateStr(r.spentDate) === ym)
    .slice()
    .sort((a,b) => {
      const ad = normalizeISODate(a.spentDate) || "0000-00-00";
      const bd = normalizeISODate(b.spentDate) || "0000-00-00";
      if(bd !== ad) return bd.localeCompare(ad);
      return (b.createdAt || "").localeCompare(a.createdAt || "");
    });

  // 2) ìš”ì•½ ê³„ì‚°
  let expSum = 0;
  let incSum = 0;

  const catAgg = {};           // ì§€ì¶œ ì¹´í…Œê³ ë¦¬ í•©
  const expenseDates = new Set();

  monthItems.forEach(x=>{
    const amt = Number(x.amount || 0);
    const isIncome = x.type === "income";

    if(isIncome){
      incSum += amt;
    }else{
      expSum += amt;

      const cat = x.category || "ê¸°íƒ€";
      catAgg[cat] = (catAgg[cat] || 0) + amt;

      const dKey = (x.spentDate || "").slice(0,10);
      if(dKey) expenseDates.add(dKey);
    }
  });

  // 3) í‰ê· /ë¬´ì§€ì¶œ ê³„ì‚°
  const now = new Date();
  const [Y, M] = ym.split("-").map(n => parseInt(n,10));
  const isThisMonth = (now.getFullYear() === Y) && ((now.getMonth()+1) === M);

  const daysElapsed = isThisMonth
    ? now.getDate()
    : new Date(Y, M, 0).getDate();

  const avgPerDay = daysElapsed > 0 ? Math.round(expSum / daysElapsed) : 0;
  const noSpendDays = Math.max(0, daysElapsed - expenseDates.size);

  // 4) ì œëª©/ìš”ì•½
  titleEl.textContent = `${Y}ë…„ ${String(M).padStart(2,"0")}ì›”`;

  summaryEl.innerHTML = `
    ì´ë²ˆë‹¬ ì§€ì¶œ: <b class="amt-expense">${fmtKRW(expSum)}</b> Â· ìˆ˜ì…: <b class="amt-income">${fmtKRW(incSum)}</b><br>
    í•˜ë£¨ í‰ê·  ì§€ì¶œ: <b class="amt-expense">${fmtKRW(avgPerDay)}</b> (ì´ ${daysElapsed}ì¼ ê¸°ì¤€)<br>
    ë¬´ì§€ì¶œ: <b>${noSpendDays}ì¼</b>
  `;

  // 5) TOP3 (ì§€ì¶œ ì¹´í…Œê³ ë¦¬)
  if(top3El){
    const top3 = Object.entries(catAgg)
      .sort((a,b)=> b[1] - a[1])
      .slice(0,3);

    top3El.innerHTML = top3.length
      ? `<span style="font-weight:800; letter-spacing:-0.2px;">TOP3</span><br>
         ${top3.map(([cat,amt], i)=>`${i+1}. ${cat} Â· ${fmtKRW(amt)}`).join("<br>")}`
      : `TOP3: ì•„ì§ ì§€ì¶œ ê¸°ë¡ì´ ì—†ì–´ ğŸ™‚`;
  }

  // âœ… 6) í•„í„° ì ìš©
  const filteredItems =
  (typeof applyMonthlyFilters === "function")
    ? applyMonthlyFilters(monthItems)
    : monthItems;

  // 7) ë¦¬ìŠ¤íŠ¸ ë Œë”
  if(monthItems.length === 0){
    listEl.innerHTML = `<p class="hint">ì´ ë‹¬ ê¸°ë¡ì´ ì—†ì–´. +ë¡œ ì¶”ê°€í•´ë´!</p>`;
    return;
  }

  if(filteredItems.length === 0){
  listEl.innerHTML = `<p class="hint monthly-empty">í•„í„° ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ì–´ ğŸ«§ (ì´ˆê¸°í™” ëˆŒëŸ¬ë´)</p>`;
  return;
  }
  
  listEl.innerHTML = filteredItems.map(x=>{
    const d = (x.spentDate || "").replaceAll("-", ". ");
    const dateText = d ? (d + ".") : "";
    const sub = [x.card, x.place].filter(Boolean).join(" Â· ");
    const amtSideClass = x.type === "income" ? "amt-income" : "amt-expense";

    return `
    <div class="recent-item" data-id="${x.id}" style="margin-top:10px;">
        <div class="recent-left">
          <div class="recent-meta">${dateText}</div>
          <div class="recent-title">${x.category || "ê¸°íƒ€"}</div>
          <div class="recent-sub">${sub}</div>
        </div>
        <div class="recent-right">
          <div class="recent-amt ${amtSideClass}">
            ${fmtKRW(x.amount)}
          </div>
          <button class="edit-btn" type="button" data-id="${x.id}" aria-label="ìˆ˜ì •">âœï¸</button>
          <button class="delete-btn" type="button" data-id="${x.id}" aria-label="ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }).join("");
}    

/* =========================
   ğŸ“Š í†µê³„: ì´ë²ˆë‹¬ ë„ë„› + Top5
   ========================= */

// âœ… ì´ë²ˆë‹¬ YYYY-MM êµ¬í•˜ê¸° (ë¡œì»¬)
function currentYM(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

// âœ… ì¹´í…Œê³ ë¦¬ í•©ê³„(ì§€ì¶œë§Œ) ì§‘ê³„ â†’ Top5 + ê¸°íƒ€ë¡œ ë¬¶ê¸°
function aggMonthCategories(ym){
  const records = loadRecords();
  const catAgg = {}; // {cat: sum}

  records.forEach(r=>{
    if((r.spentDate || "").slice(0,7) !== ym) return;
    const isIncome = (r.type === "income");
    if(isIncome) return;

    const cat = r.category || "ê¸°íƒ€";
    catAgg[cat] = (catAgg[cat] || 0) + Number(r.amount || 0);
  });

  const entries = Object.entries(catAgg).sort((a,b)=> b[1]-a[1]);
  const total = entries.reduce((acc, [,v])=> acc+v, 0);

  const top5 = entries.slice(0,5);
  const rest = entries.slice(5);
  const etcSum = rest.reduce((acc, [,v])=> acc+v, 0);

  const finalList = etcSum > 0
    ? [...top5, ["ê¸°íƒ€", etcSum]]
    : top5;

  return { total, list: finalList };
}

// âœ… ìƒ‰ íŒ”ë ˆíŠ¸(ì§€ê¸ˆ UIë‘ ì˜ ì–´ìš¸ë¦¬ëŠ” í†¤)
const DONUT_COLORS = [
  "rgba(127,174,158,.9)",  // sage
  "rgba(107,141,255,.9)",  // blue
  "rgba(201,74,74,.88)",   // muted red
  "rgba(227,176,75,.88)",  // mustard
  "rgba(138,124,168,.88)", // purple
  "rgba(176,184,196,.9)"   // gray (ê¸°íƒ€)
];

// âœ… SVG ë„ë„› ìƒì„± (stroke-dasharrayë¡œ ì¡°ê° ë§Œë“¤ê¸°)
function renderDonutSVG(items, total){
  const PANEL = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#ffffff';
  const size = 140;
  const cx = size/2;
  const cy = size/2;
  const r = 52;
  const stroke = 16;
  const C = 2 * Math.PI * r;

  if(!items.length || total <= 0){
    const ymDot = currentYM().replace("-", "."); // âœ… 2026.02
    return `
      <svg class="donut" viewBox="0 0 ${size} ${size}">
        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${PANEL}" stroke-width="${stroke}" />
        <circle cx="${cx}" cy="${cy}" r="${r-18}" fill="${PANEL}" />
        <g class="donut-center">
          <text x="${cx}" y="${cy-6}" class="ym">${ymDot}</text>
          <text x="${cx}" y="${cy+10}" class="total">0ì›</text>
        </g>
      </svg>
    `;
  }

  let offset = 0;
  const segments = items.map(([name, value], i)=>{
    const frac = value / total;
    const GAP = 2; // âœ… ì¡°ê° ì‚¬ì´ í‹ˆ(í”½ì…€) - 2~5 ì¶”ì²œ
    const dash = Math.max(1, (frac * C) - GAP); // ì¡°ê° ê¸¸ì´ì—ì„œ GAPë§Œí¼ ë¹¼ê¸°
    const gap  = C - dash;

    const seg = `
      <circle
        cx="${cx}" cy="${cy}" r="${r}"
        fill="none"
        stroke="${DONUT_COLORS[i] || DONUT_COLORS[DONUT_COLORS.length-1]}"
        stroke-width="${stroke}"
        stroke-linecap="butt"
        stroke-dasharray="${dash} ${gap}"
        stroke-dashoffset="${-offset}"
        transform="rotate(-90 ${cx} ${cy})"
        class="donut-seg"
        data-name="${name}"
        data-val="${value}"
        style="cursor:pointer;"
      />
    `;
    offset += (dash + GAP);
    return seg;
  }).join("");

  // âœ… ë„ë„› ë Œë”
  const ymDot = currentYM().replace("-", "."); // âœ… 2026.02

  return `
    <svg class="donut" viewBox="0 0 ${size} ${size}">
      <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${PANEL}" stroke-width="${stroke}" />
      ${segments}
      <circle cx="${cx}" cy="${cy}" r="${r-18}" fill="${PANEL}" />

      <g class="donut-center">
        <text x="${cx}" y="${cy-6}" class="ym">${ymDot}</text>
        <text x="${cx}" y="${cy+10}" class="total">${fmtKRW(total)}</text>
      </g>
    </svg>
  `;
}

// âœ… í†µê³„ íƒ­ ë Œë”(ì´ë²ˆë‹¬ ê¸°ì¤€)
function renderStats(){
  const ym = currentYM();
  const { total, list } = aggMonthCategories(ym);

  const donutEl = document.getElementById("statsDonut");
  const totalEl = document.getElementById("statsTotalExpense");
  const top1El  = document.getElementById("statsTop1");
  const top5El  = document.getElementById("statsTop5");

  if(donutEl) donutEl.innerHTML = renderDonutSVG(list, total);
  if(donutEl){
    donutEl.onclick = (e) => {
      const seg = e.target.closest(".donut-seg");
      if(!seg) return;

      const name = seg.dataset.name;
      const val  = Number(seg.dataset.val || 0);
      const pct  = total ? Math.round((val/total)*100) : 0;

      if(top1El){
        top1El.innerHTML = `<b>${name}</b> Â· ${fmtKRW(val)} (${pct}%)`;
      }
    };
  }
  
  if(totalEl) totalEl.textContent = fmtKRW(total);

  if(top1El){
    if(list.length && total > 0){
      const [name, val] = list[0];
      const pct = Math.round((val/total)*100);
      top1El.innerHTML = `1ìœ„: <b>${name}</b> Â· ${fmtKRW(val)} (${pct}%)`;
    }else{
      top1El.textContent = "ì´ë²ˆ ë‹¬ ì§€ì¶œ ê¸°ë¡ì´ ì—†ì–´ ğŸ™‚";
    }
  }

  if(top5El){
    if(!list.length || total <= 0){
      top5El.innerHTML = `<p class="hint">ì•„ì§ ë°ì´í„°ê°€ ì—†ì–´. ì§€ì¶œì„ ì¶”ê°€í•´ë´!</p>`;
      return;
    }

    // âœ… TOP5ë§Œ ë§‰ëŒ€ë¡œ (ê¸°íƒ€ëŠ” ë§‰ëŒ€ì—ì„œ ë¹¼ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ í•„í„°)
    const onlyTop5 = list.filter(([n]) => n !== "ê¸°íƒ€").slice(0,5);
    const maxVal = Math.max(...onlyTop5.map(([,v])=> v), 1);

    top5El.innerHTML = onlyTop5.map(([name, val], i)=>{
      const pct = Math.round((val / total) * 100);
      const w = Math.round((val / maxVal) * 100);

      return `
        <div class="bar-row">
          <div class="bar-name">${name}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${w}%; background:${DONUT_COLORS[i] || "#9AA3AF"};"></div>
          </div>
          <div class="bar-amt">${fmtKRW(val)}<span class="hint" style="margin-left:6px;">${pct}%</span></div>
        </div>
      `;
    }).join("");
  }
}



    
/* =========================
   ğŸ“… ì›”ë³„ í•©ê³„(ì§€ì¶œ/ìˆ˜ì…) í‘œì‹œ
   ========================= */
function renderMonthlySummary(ym){
  const titleEl = document.getElementById("monthlyTitle");
  const summaryEl = document.getElementById("monthlySummary");
  if(!titleEl || !summaryEl) return;

  const list = loadRecords().filter(r => (r.spentDate || "").startsWith(ym));

  let expense = 0;
  let income = 0;

  list.forEach(r => {
    const amt = Number(r.amount || 0);
    if(r.type === "income") income += amt;
    else expense += amt;
  });

  const [y,m] = ym.split("-");
  titleEl.textContent = `${y}ë…„ ${m}ì›”`;
  summaryEl.textContent =
    `ì§€ì¶œ ${expense.toLocaleString("ko-KR")}ì› Â· ìˆ˜ì… ${income.toLocaleString("ko-KR")}ì›`;

  if(list.length === 0){
    summaryEl.textContent = "ì´ ë‹¬ì—” ê¸°ë¡ì´ ì—†ì–´ ğŸ«§";
  }
  
}
    
    
    
function renderRecent(){
 
  const todayKey = localISODate(new Date());

  const y = new Date();
  y.setDate(y.getDate() - 1);
  const yesterdayKey = localISODate(y);

  let todayLabelShown = false;
  let yesterdayLabelShown = false;
  
  const wrap = document.getElementById("recentList");
  if(!wrap) return;

  const all = loadRecords().slice();

  // âœ… (ì„ íƒ) ì˜ˆì „ ë°ì´í„°ì— id ì—†ìœ¼ë©´ ë³´ê°•
  let changed = false;
  all.forEach(x=>{
    if(!x.id){
      x.id = (crypto?.randomUUID?.() || ("id_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
      changed = true;
    }
  });
  if(changed){
    localStorage.setItem("records", JSON.stringify(all));
  }

  // âœ… ì›”ë³„ í•©ê³„
  const monthAgg = {};
  all.forEach(x=>{
    const ym = (x.spentDate || "").slice(0,7);
    if(!ym || !ym.includes("-")) return;
    if(!monthAgg[ym]) monthAgg[ym] = { expense: 0, income: 0 };
    const amt = Number(x.amount || 0);
    if(x.type === "income") monthAgg[ym].income += amt;
    else monthAgg[ym].expense += amt;
  });



  // âœ… ì •ë ¬
  const list = all
    .sort((a, b) => {
      const ad = (a.spentDate || "0000-00-00");
      const bd = (b.spentDate || "0000-00-00");
      if (bd !== ad) return bd.localeCompare(ad);
      return (b.createdAt || "").localeCompare(a.createdAt || "");
    })
    .slice(0, 7);

  
  if(list.length === 0){
    wrap.innerHTML = `<p class="hint">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´. +ë¡œ ì¶”ê°€í•´ë´!</p>`;
    renderTodaySpend();   // âœ… ê¸°ë¡ ì—†ì–´ë„ 0ì›ìœ¼ë¡œ ê°±ì‹ 
    return;
  }

  const monthLabel = (iso) => {
    const s = (iso || "").slice(0,7);
    if(!s.includes("-")) return "ë‚ ì§œ ì—†ìŒ";
    const [y,m] = s.split("-");
    return `${y}ë…„ ${m}ì›”`;
  };

  const monthSumText = (ym) => {
    const agg = monthAgg[ym] || { expense: 0, income: 0 };
    const exp = Number(agg.expense || 0).toLocaleString("ko-KR");
    const inc = Number(agg.income || 0).toLocaleString("ko-KR");
    return `ì§€ì¶œ ${exp} Â· ìˆ˜ì… ${inc}`;
  };

  let html = "";
  let prevMonth = "";

  list.forEach(x => {
  const ym = (x.spentDate || "").slice(0,7);

  // ì›” í—¤ë”
  if(ym !== prevMonth){
    html += `
      <div class="month-header">
        <div class="month-title">${monthLabel(x.spentDate)}</div>
        <div class="month-sum">${monthSumText(ym)}</div>
      </div>
    `;
    prevMonth = ym;
  }

  // âœ… ì˜¤ëŠ˜/ì–´ì œ êµ¬ë¶„ì„  (spentDate ê¸°ì¤€)
  const dKey = (x.spentDate || "").slice(0,10);

  if(dKey === todayKey && !todayLabelShown){
    html += `<div class="month-sep">ì˜¤ëŠ˜</div>`;
    todayLabelShown = true;
  }

  if(dKey === yesterdayKey && !yesterdayLabelShown){
    html += `<div class="month-sep">ì–´ì œ</div>`;
    yesterdayLabelShown = true;
  }
    
  // ë‚ ì§œ
  const d = (x.spentDate || "").replaceAll("-", ". ");
  const dateText = d ? (d + ".") : "";

  // ì˜¤ëŠ˜ í‘œì‹œ
  const isToday = (x.spentDate || "").slice(0,10) === todayKey;
  const todayDot = isToday ? `<span class="memo-dot"></span>` : "";

  // ì•„ë˜ì¤„
  const sub = [x.card, x.place].filter(Boolean).join(" Â· ");
  const amtSideClass = x.type === "income" ? "amt-income" : "amt-expense";

  html += `
    <div class="recent-item" data-id="${x.id}">
      <div class="recent-left">
        <div class="recent-meta">${dateText}</div>
        <div class="recent-title">
          ${x.category || "ê¸°íƒ€"}${todayDot}
        </div>
        <div class="recent-sub">${sub}</div>
      </div>

      <div class="recent-right">
        <div class="recent-amt ${amtSideClass}">
          ${fmtKRW(x.amount)}
        </div>
        <button class="edit-btn" type="button" data-id="${x.id}" aria-label="ìˆ˜ì •">âœï¸</button>
        <button class="delete-btn" type="button" data-id="${x.id}" aria-label="ì‚­ì œ">ğŸ—‘ï¸</button>
      </div>
    </div>
  `;
});


  wrap.innerHTML = html;
  renderTodaySpend();
}



    

      

/* =========================
   âœï¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
   ========================= */
document.getElementById("recentList")?.addEventListener("click", (e) => {
  const btn = e.target.closest(".edit-btn");
  if(!btn) return;

  e.stopPropagation(); // âœ… í˜¹ì‹œ ë‹¤ë¥¸ í´ë¦­ ì´ë²¤íŠ¸ê°€ ìƒê²¨ë„ ì—°í•„ë§Œ ë…ë¦½ ë°˜ì‘

  const id = btn.dataset.id;
  if(!id) return;

  const all = loadRecords();
  const item = all.find(r => r.id === id);
  if(!item) return;

  fillFormForEdit(item);
  openModal();
});



   /* =========================
   âœï¸ ì›”ë³„ - ìˆ˜ì • ë²„íŠ¼
   ========================= */
document.getElementById("monthlyList")?.addEventListener("click", (e) => {
  const btn = e.target.closest(".edit-btn");
  if(!btn) return;

  e.stopPropagation();

  const id = btn.dataset.id;
  if(!id) return;

  const item = loadRecords().find(r => r.id === id);
  if(!item) return;

  fillFormForEdit(item);
  openModal();
});



    /* =========================
   ğŸ—‘ï¸ ì›”ë³„ - ì‚­ì œ + Undo
   ========================= */
document.getElementById("monthlyList")?.addEventListener("click", (e) => {
  const del = e.target.closest(".delete-btn");
  if(!del) return;

  e.stopPropagation();

  const id = del.dataset.id;
  if(!id) return;

  const list = loadRecords();
  const idx = list.findIndex(r => r.id === id);
  if(idx < 0) return;

  if(pendingDelete?.timerId){
    clearTimeout(pendingDelete.timerId);
    pendingDelete = null;
  }

  const removed = list[idx];

  list.splice(idx, 1);
  localStorage.setItem("records", JSON.stringify(list));

  // âœ… í™ˆ/ì›”ë³„ ë‘˜ ë‹¤ ê°±ì‹ 
  renderRecent();
  renderMonthly(getCurrentYM());

  pendingDelete = { item: removed, index: idx, timerId: null };
  showToast("ì‚­ì œë¨", { undo: true });

  pendingDelete.timerId = setTimeout(() => {
    pendingDelete = null;
  }, UNDO_DURATION);
});

    

    /* =========================
   ğŸ“ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ì—´ê¸° (í•­ëª© í´ë¦­)
   ========================= */
document.getElementById("recentList")?.addEventListener("click", (e)=>{
  // âœï¸ ìˆ˜ì • / ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ
  if(e.target.closest(".edit-btn")) return;
  if(e.target.closest(".delete-btn")) return;

  const itemEl = e.target.closest(".recent-item");
  if(!itemEl) return;

  const id = itemEl.dataset.id;
  if(!id) return;

  const item = loadRecords().find(r => r.id === id);
  if(!item) return;

  openMemoSlide(item);
});

    

    document.getElementById("monthlyList")?.addEventListener("click", (e)=>{
  const itemEl = e.target.closest(".recent-item");
  if(!itemEl) return;

  const id = itemEl.dataset.id;
  if(!id) return;

  const item = loadRecords().find(r => r.id === id);
  if(!item) return;

  openMemoSlide(item);
});
    

// ===== ì›”ë³„ íƒ­ ì „ìš© í•„í„° ìƒíƒœ =====
const mFilter = {
  type: "all",        // all | expense | income
  category: "all",
  card: "all",
  q: ""
};

/* =========================
   âœ… ì›”ë³„ mbar(ê°€ë¡œì¹©) + íŒ¨ë„ ë™ì‘
   ========================= */

const mbar = document.getElementById("monthlyBar");
const panel = document.getElementById("mbarPanel");

function getCurrentYM(){
  const sel = document.getElementById("monthSelect");
  return sel?.value || currentYM();
}

function rerenderMonthly(){
  renderMonthly(getCurrentYM());
}

function setActiveTypeChip(type){ // all | expense | income
  if(!mbar) return;
  mbar.querySelectorAll(".mchip[data-type]").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.type === type);
  });
}

function closePanel(){
  if(!panel) return;
  panel.classList.add("hidden");
  panel.innerHTML = "";
  panel.dataset.kind = "";
}

function openPanel(kind){ // "category" | "card" | "search"
  if(!panel) return;

  // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ë‹«ê¸°
  if(!panel.classList.contains("hidden") && panel.dataset.kind === kind){
    closePanel();
    return;
  }

  panel.dataset.kind = kind;
  panel.classList.remove("hidden");

  if(kind === "category"){
    const opts = ["all", ...CATEGORIES];
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <select id="mPanelCategory" style="flex:1;">
          ${opts.map(c=>`<option value="${c}">${c==="all" ? "ì¹´í…Œê³ ë¦¬: ì „ì²´" : c}</option>`).join("")}
        </select>
        <button type="button" class="mchip" id="mPanelApply">ì ìš©</button>
      </div>
    `;
    const sel = document.getElementById("mPanelCategory");
    sel.value = mFilter.category || "all";
    document.getElementById("mPanelApply").onclick = ()=>{
      mFilter.category = sel.value;
      closePanel();
      rerenderMonthly();
    };
    return;
  }

  if(kind === "card"){
    const cards = ["all", "ì‚¼ì„±", "ì‹ í•œ", "êµ­ë¯¼", "í˜„ê¸ˆ/ê³„ì¢Œ"];
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <select id="mPanelCard" style="flex:1;">
          ${cards.map(c=>`<option value="${c}">${c==="all" ? "ì¹´ë“œ: ì „ì²´" : c}</option>`).join("")}
        </select>
        <button type="button" class="mchip" id="mPanelApply">ì ìš©</button>
      </div>
    `;
    const sel = document.getElementById("mPanelCard");
    sel.value = mFilter.card || "all";
    document.getElementById("mPanelApply").onclick = ()=>{
      mFilter.card = sel.value;
      closePanel();
      rerenderMonthly();
    };
    return;
  }

  if(kind === "search"){
    panel.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="mPanelQuery" type="text" placeholder="ì‚¬ìš©ì²˜/ë©”ëª¨ ê²€ìƒ‰"
               style="flex:1; min-width:0;" />
        <button type="button" class="mchip" id="mPanelApply">ì ìš©</button>
      </div>
      <div class="hint" style="margin-top:8px;">ì—”í„°ë¡œë„ ì ìš©ë¨</div>
    `;
    const q = document.getElementById("mPanelQuery");
    q.value = mFilter.q || "";
    q.focus();
    const apply = ()=>{
      mFilter.q = (q.value || "").trim();
      closePanel();
      rerenderMonthly();
    };
    document.getElementById("mPanelApply").onclick = apply;
    q.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        apply();
      }
    });
    return;
  }
}

// âœ… mbar í´ë¦­ í•¸ë“¤ëŸ¬
mbar?.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  // íƒ€ì…(ì „ì²´/ì§€ì¶œ/ìˆ˜ì…)
  if(btn.dataset.type){
    mFilter.type = btn.dataset.type; // all | expense | income
    setActiveTypeChip(mFilter.type);
    closePanel();
    rerenderMonthly();
    return;
  }

  // ë“œë¡­ë‹¤ìš´ë“¤
  if(btn.id === "mbarCategoryBtn"){
    openPanel("category");
    return;
  }
  if(btn.id === "mbarCardBtn"){
    openPanel("card");
    return;
  }
  if(btn.id === "mbarSearchBtn"){
    openPanel("search");
    return;
  }

  // ì´ˆê¸°í™”
  if(btn.id === "mbarReset"){
    mFilter.type = "all";
    mFilter.category = "all";
    mFilter.card = "all";
    mFilter.q = "";
    setActiveTypeChip("all");
    closePanel();
    rerenderMonthly();
    return;
  }
});

// âœ… íŒ¨ë„ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (ì›”ë³„ ì¹´ë“œ ì•ˆì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ)
document.addEventListener("click", (e)=>{
  if(!panel || panel.classList.contains("hidden")) return;
  if(e.target.closest("#monthlyBar")) return;
  if(e.target.closest("#mbarPanel")) return;
  closePanel();
});

// âœ… ì›”ë³„ íƒ­ ë“¤ì–´ì˜¬ ë•Œ ì¹© ìƒíƒœ ë™ê¸°í™”
function syncMonthlyBarUI(){
  setActiveTypeChip(mFilter.type || "all");
  closePanel();
}

    


    

function applyMonthlyFilters(records){
  const q = (mFilter.q || "").trim().toLowerCase();

  return records.filter(r=>{
    if(mFilter.type !== "all"){
      if((r.type || "expense") !== mFilter.type) return false;
    }
    if(mFilter.category !== "all"){
      if((r.category || "ê¸°íƒ€") !== mFilter.category) return false;
    }
    if(mFilter.card !== "all"){
      if((r.card || "") !== mFilter.card) return false;
    }
    if(q){
      const place = (r.place || "").toLowerCase();
      const memo  = (r.memo  || "").toLowerCase();
      if(!place.includes(q) && !memo.includes(q)) return false;
    }
    return true;
  });
}

    

  /* =========================
   âœ… Toast (ë‹¨ì¼)
   ========================= */
const toastEl = document.getElementById("toast");
const toastTextEl = document.getElementById("toastText");
const toastUndoBtn = document.getElementById("toastUndo");

let toastTimer = null;
let pendingDelete = null; // { item, index, timerId }
const UNDO_DURATION = 5000;

function showToast(text, { undo=false, duration=1400 } = {}){
  if(!toastEl || !toastTextEl) return;

  // íƒ€ì´ë¨¸ ì •ë¦¬
  if(toastTimer) clearTimeout(toastTimer);
  if(pendingDelete?.timerId && !undo){
    clearTimeout(pendingDelete.timerId);
    pendingDelete = null;
  }

  toastTextEl.textContent = text;

  if(toastUndoBtn){
    toastUndoBtn.style.display = undo ? "inline-flex" : "none";
  }

  toastEl.classList.remove("hidden", "hide");
  toastEl.classList.add("show");

  // undo í† ìŠ¤íŠ¸ëŠ” 5ì´ˆ í›„ ìë™ ë‹«ê¸° (undo ê°€ëŠ¥ ì‹œê°„)
  const ms = undo ? UNDO_DURATION : duration;

  toastTimer = setTimeout(() => {
    toastEl.classList.remove("show");
    toastEl.classList.add("hide");

    setTimeout(() => {
      toastEl.classList.add("hidden");
      toastEl.classList.remove("hide");
    }, 220);
  }, ms);
}

function hideToast(){
  if(!toastEl) return;
  toastEl.classList.add("hidden");
  toastEl.classList.remove("show", "hide");
}

/* =========================
   ğŸ—‘ï¸ ì‚­ì œ + Undo (5ì´ˆ)
   ========================= */
document.getElementById("recentList")?.addEventListener("click", (e) => {
  const del = e.target.closest(".delete-btn"); // âœ… í´ë˜ìŠ¤ ë§ì¶¤
  if(!del) return;

  e.stopPropagation();

  const id = del.dataset.id;
  if(!id) return;

  const list = loadRecords();
  const idx = list.findIndex(r => r.id === id);
  if(idx < 0) return;

  // ê¸°ì¡´ pendingDelete ìˆìœ¼ë©´ íƒ€ì´ë¨¸ ì •ë¦¬
  if(pendingDelete?.timerId){
    clearTimeout(pendingDelete.timerId);
    pendingDelete = null;
  }

  const removed = list[idx];

  // 1) ì¦‰ì‹œ ì œê±°
  list.splice(idx, 1);
  localStorage.setItem("records", JSON.stringify(list));
  renderRecent();

  // 2) pending ì €ì¥
  pendingDelete = { item: removed, index: idx, timerId: null };

  // 3) í† ìŠ¤íŠ¸ ë„ìš°ê¸°(undo ë²„íŠ¼ í¬í•¨, 5ì´ˆ ìœ ì§€)
  showToast("ì‚­ì œë¨", { undo: true });

  pendingDelete.timerId = setTimeout(() => {
    pendingDelete = null;
    // ì‹œê°„ ì§€ë‚˜ë©´ ê·¸ëƒ¥ ë‹«í˜(ì´ë¯¸ ì €ì¥ì†Œì—ì„œ ì‚­ì œë¨)
  }, UNDO_DURATION);
});

// âœ… Undo í´ë¦­ â†’ ë³µêµ¬
toastUndoBtn?.addEventListener("click", () => {
  if(!pendingDelete) return;

  clearTimeout(pendingDelete.timerId);

  const { item, index } = pendingDelete;
  const list = loadRecords();

  const safeIndex = (index >= 0 && index <= list.length) ? index : 0;
  list.splice(safeIndex, 0, item);

  localStorage.setItem("records", JSON.stringify(list));
  renderRecent();
  renderMonthly(getCurrentYM());

  pendingDelete = null;

  showToast("ë³µêµ¬ë¨ âœ“", { undo: false, duration: 1200 });
});

// âœ… í™ˆ ë²„íŠ¼: ì›”ë³„ íƒ­ìœ¼ë¡œ ì´ë™
document.getElementById("goMonthly")?.addEventListener("click", () => {
  setActiveTab("monthly");
  window.scrollTo(0, 0);
});
    

// í˜ì´ì§€ ì²˜ìŒ ì—´ë¦´ ë•Œ 1ë²ˆ ì‹¤í–‰
renderRecent();
renderTodaySpend();
renderMonthSelect(); // âœ… ì¶”ê°€
renderStats();
    
// í˜ì´ì§€ ìµœì´ˆ ë¡œë”© ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
window.scrollTo(0, 0);

document.getElementById("monthSelect")?.addEventListener("change", (e)=>{
  renderMonthly(e.target.value);
});

    
  </script>

  
</body>
</html>
